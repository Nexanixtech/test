<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Categories - Technovation</title>
    <link href="/public/tecpn.png" rel="shortcut icon" type="image/x-icon" />
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="admin.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        .image-preview {
            width: 100%;
            max-width: 200px;
            margin-top: 10px;
            border-radius: 5px;
            display: none;
        }

        .upload-btn-wrapper {
            position: relative;
            margin-bottom: 15px;
        }

        .upload-btn {
            padding: 8px 16px;
            border-radius: 4px;
            background-color: #f0f0f0;
            cursor: pointer;
            display: inline-block;
        }

        .upload-btn-wrapper input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        /* Fixed grid layout */
        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .category-card {
            border: 1px solid #eaeaea;
            border-radius: 5px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            background: white;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .category-image-container {
            height: 150px;
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        .category-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .no-image {
            height: 100%;
            width: 100%;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #777;
            font-size: 14px;
        }

        .category-info {
            padding: 15px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .category-updated {
            font-size: 12px;
            color: #888;
            margin-bottom: 10px;
            font-style: italic;
        }
        .category-card h4 {
            margin: 0 0 5px;
            font-size: 18px;
        }

        .category-type {
            color: #666;
            font-size: 14px;
            margin: 0 0 15px;
            font-style: italic;
        }

        .delete-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            align-self: flex-start;
            margin-top: auto;
        }

        .delete-btn:hover {
            background-color: #c0392b;
        }

        .category-description {
            font-size: 13px;
            color: #666;
            margin: 0 0 15px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            text-overflow: ellipsis;
            line-height: 1.4;
        }

        .category-info {
            padding: 15px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 5px;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .close-modal {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-modal:hover {
            color: #333;
        }

        .edit-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }

        .edit-btn:hover {
            background-color: #2980b9;
        }

        .current-image-container {
            margin-bottom: 15px;
            text-align: center;
            display: none;
        }

        .current-image-container img {
            max-width: 100px;
            max-height: 100px;
            margin-bottom: 5px;
            border: 1px solid #ddd;
            padding: 5px;
            border-radius: 5px;
        }

        .current-image-container p {
            font-size: 13px;
            color: #666;
            margin: 0;
        }

        .button-container {
            display: flex;
            gap: 10px;
            margin-top: auto;
        }

        .main-image-preview {
            margin-top: 10px;
            margin-bottom: 15px;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }

        .main-image-preview p {
            font-size: 13px;
            color: #666;
            margin-bottom: 5px;
        }

        .main-category-image {
            max-width: 100px;
            max-height: 100px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 3px;
        }

        .category-color-indicator {
            height: 10px;
            width: 100%;
            margin-bottom: 10px;
            border-radius: 3px;
        }
        .remove-image-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 5px;
        }
        
        .remove-image-btn:hover {
            background-color: #c0392b;
        }
    </style>
</head>

<body>
    <div class="admin-container">
        <h2>Manage Categories</h2>

        <!-- Add Category Form -->
        <div class="category-form">
            <h3>Add New Category</h3>
            <form id="addCategoryForm">
                <div class="form-group">
                    <label for="categoryName">Category Name</label>
                    <input type="text" id="categoryName" required>
                </div>
                <div class="form-group">
                    <label>Background Image</label>
                    <div class="upload-btn-wrapper">
                        <div class="upload-btn">Choose Background Image</div>
                        <input type="file" id="categoryBgImage" accept="image/*">
                    </div>
                    <img id="bgImagePreview" class="image-preview" alt="Preview">
                </div>
                <div class="form-group">
                    <label for="categoryColor">Category Color</label>
                    <input type="color" id="categoryColor" value="#3498db">
                </div>
                <div class="form-group">
                    <label for="categoryNameColor">Category Name Color</label>
                    <input type="color" id="categoryNameColor" value="#000000">
                </div>

                <!-- Add after category description -->
                <div class="form-group">
                    <label for="categoryDescriptionColor">Description Color</label>
                    <input type="color" id="categoryDescriptionColor" value="#666666">
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="isMainCategory">
                        Main Category
                    </label>
                </div>
                <!-- Add this to the category form -->
                <div class="form-group">
                    <label for="categoryDescription">Description</label>
                    <textarea id="categoryDescription" rows="3" placeholder="Enter category description"></textarea>
                </div>
                <!-- Add this after the regular category image section in the form -->
                <div class="form-group">
                    <label>Main Category Image</label>
                    <div class="upload-btn-wrapper">
                        <div class="upload-btn">Choose Main Image</div>
                        <input type="file" id="categoryMainImage" accept="image/*">
                    </div>
                    <img id="mainImagePreview" class="image-preview" alt="Preview">
                </div>
                <div class="form-group">
                    <label>Category Image</label>
                    <div class="upload-btn-wrapper">
                        <div class="upload-btn">Choose Image</div>
                        <input type="file" id="categoryImage" accept="image/*">
                    </div>
                    <img id="imagePreview" class="image-preview" alt="Preview">
                </div>
                <button type="submit" class="submit-btn">Add Category</button>
            </form>
        </div>

        <!-- Categories List -->
        <div class="categories-list">
            <h3>Existing Categories</h3>
            <div class="categories-grid" id="categoriesGrid">
                <!-- Categories will be loaded here -->
            </div>


            <!-- Add this edit modal form -->
            <div id="editCategoryModal" class="modal">
                <div class="modal-content">
                    <span class="close-modal">&times;</span>
                    <h3>Edit Category</h3>
                    <form id="editCategoryForm">
                        <input type="hidden" id="editCategoryId">
                        <div class="form-group">
                            <label for="editCategoryName">Category Name</label>
                            <input type="text" id="editCategoryName" required>
                        </div>
                        <div class="form-group">
                            <label>Category Background Image</label>
                            <div class="current-image-container" id="currentBgImageContainer">
                                <img id="currentBgImage" alt="Current Background Image">
                                <p>Current Background Image</p>
                                <button type="button" class="remove-image-btn" id="removeBgImage">Remove Background Image</button>
                            </div>
                            <div class="upload-btn-wrapper">
                                <div class="upload-btn">Choose New Background Image</div>
                                <input type="file" id="editCategoryBgImage" accept="image/*">
                            </div>
                            <img id="editBgImagePreview" class="image-preview" alt="Preview">
                        </div>
                        <div class="form-group">
                            <label for="editCategoryColor">Category Color</label>
                            <input type="color" id="editCategoryColor" value="#3498db">
                        </div>
                        <div class="form-group">
                            <label for="editCategoryNameColor">Category Name Color</label>
                            <input type="color" id="editCategoryNameColor" value="#000000">
                        </div>

                        <!-- Add after edit category description -->
                        <div class="form-group">
                            <label for="editCategoryDescriptionColor">Description Color</label>
                            <input type="color" id="editCategoryDescriptionColor" value="#666666">
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="editIsMainCategory">
                                Main Category
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="editCategoryDescription">Description</label>
                            <textarea id="editCategoryDescription" rows="3"
                                placeholder="Enter category description"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Category Image</label>
                            <div class="current-image-container" id="currentImageContainer">
                                <img id="currentImage" alt="Current Image">
                                <p>Current Image</p>
                            </div>
                            <div class="upload-btn-wrapper">
                                <div class="upload-btn">Choose New Image</div>
                                <input type="file" id="editCategoryImage" accept="image/*">
                            </div>
                            <img id="editImagePreview" class="image-preview" alt="Preview">
                        </div>
                        <!-- Add this to the edit modal form after the regular image section -->
                        <div class="form-group">
                            <label>Main Category Image</label>
                            <div class="current-image-container" id="currentMainImageContainer">
                                <img id="currentMainImage" alt="Current Main Image">
                                <p>Current Main Image</p>
                                <button type="button" class="remove-image-btn" id="removeMainImage">Remove Main Image</button>
                            </div>
                            <div class="upload-btn-wrapper">
                                <div class="upload-btn">Choose New Main Image</div>
                                <input type="file" id="editCategoryMainImage" accept="image/*">
                            </div>
                            <img id="editMainImagePreview" class="image-preview" alt="Preview">
                        </div>
                        <button type="submit" class="submit-btn">Update Category</button>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <script type="module">
        import { supabase } from '../supabase.js'

        // Check if user is authenticated
        const session = JSON.parse(localStorage.getItem('adminSession'))
        if (!session) {
            window.location.href = 'login.html'
        }

        // Handle image preview
        document.getElementById('categoryImage').addEventListener('change', function (event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const preview = document.getElementById('imagePreview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                }
                reader.readAsDataURL(file);
            }
        });
        // For add category form
        document.getElementById('categoryBgImage').addEventListener('change', function (event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const preview = document.getElementById('bgImagePreview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                }
                reader.readAsDataURL(file);
            }
        });

        // For edit category form
        document.getElementById('editCategoryBgImage').addEventListener('change', function (event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const preview = document.getElementById('editBgImagePreview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                }
                reader.readAsDataURL(file);
            }
        });

        // Add event listeners for remove buttons
document.getElementById('removeBgImage').addEventListener('click', function() {
    document.getElementById('currentBgImageContainer').style.display = 'none';
    // Set a flag to indicate image should be removed
    document.getElementById('editCategoryForm').dataset.removeBgImage = 'true';
});

document.getElementById('removeMainImage').addEventListener('click', function() {
    document.getElementById('currentMainImageContainer').style.display = 'none';
    // Set a flag to indicate image should be removed
    document.getElementById('editCategoryForm').dataset.removeMainImage = 'true';
});
        // Load categories
        // Update the loadCategories function HTML template
        async function loadCategories() {
            try {
                const { data: categories, error } = await supabase
                    .from('categories')
                    .select('*')
                    .order('name')

                if (error) throw error

                const categoriesGrid = document.getElementById('categoriesGrid')
                categoriesGrid.innerHTML = categories.map(category => `
                    <div class="category-card">
                        <div class="category-image-container">
                            ${category.image_url
                        ? `<img src="${category.image_url}" class="category-image" alt="${category.name}">`

                        : `<div class="no-image">No Image Available</div>`
                    }
                        </div>
                        <div class="category-info">
                            <h4 style="color: ${category.name_color || '#000000'}">${category.name}</h4>
                        
${category.bg_image_url ?
                        `<div class="main-image-preview">
    <p>Background Image:</p>
    <img src="${category.bg_image_url}" alt="Background image for ${category.name}" class="main-category-image">
  </div>` : ''
                    }
                            <div class="category-color-indicator" style="background-color: ${category.color || '#3498db'}"></div>
                            <p class="category-updated">Last updated: ${new Date(category.created_at).toLocaleString()}</p>
                            <p class="category-type">${category.is_main ? 'Main Category' : 'Sub Category'}</p>
                           <p class="category-description" style="color: ${category.description_color || '#666666'}">${category.description || 'No description available'}</p>
                            ${category.main_image_url ?
                        `<div class="main-image-preview">
                                    <p>Main Image:</p>
                                    <img src="${category.main_image_url}" alt="Main image for ${category.name}" class="main-category-image">
                                </div>` : ''
                    }
                            <div class="category-actions">
                                <button class="edit-btn" onclick="editCategory('${category.id}')">Edit</button>
                                <button class="delete-btn" onclick="deleteCategory('${category.id}')">Delete</button>
                            </div>
                        </div>
                    </div>
                `).join('')
            } catch (error) {
                console.error('Error loading categories:', error)
            }
        }
        const color = document.getElementById('editCategoryColor').value;

        window.editCategory = async (id) => {
            try {
                const { data: category, error } = await supabase
                    .from('categories')
                    .select('*')
                    .eq('id', id)
                    .single()

                if (error) throw error

                // Populate the edit form
                document.getElementById('editCategoryId').value = category.id
                document.getElementById('editCategoryName').value = category.name
                document.getElementById('editBgImagePreview').style.display = 'none'
                document.getElementById('editIsMainCategory').checked = category.is_main
                document.getElementById('editCategoryDescription').value = category.description || ''
                document.getElementById('editCategoryColor').value = category.color || '#3498db';
                // Add to the editCategory function where you populate fields
                document.getElementById('editCategoryNameColor').value = category.name_color || '#000000';
                document.getElementById('editCategoryDescriptionColor').value = category.description_color || '#666666';

                // Show current image if exists
                const currentImageContainer = document.getElementById('currentImageContainer')
                const currentImage = document.getElementById('currentImage')

                if (category.image_url) {
                    currentImage.src = category.image_url
                    currentImageContainer.style.display = 'block'
                } else {
                    currentImageContainer.style.display = 'none'
                }
                if (category.bg_image_url) {
                    const currentBgImageContainer = document.getElementById('currentBgImageContainer')
                    const currentBgImage = document.getElementById('currentBgImage')
                    currentBgImage.src = category.bg_image_url
                    currentBgImageContainer.style.display = 'block'
                } else {
                    document.getElementById('currentBgImageContainer').style.display = 'none'
                }
                // Show current main image if exists
                const currentMainImageContainer = document.getElementById('currentMainImageContainer')
                const currentMainImage = document.getElementById('currentMainImage')

                if (category.main_image_url) {
                    currentMainImage.src = category.main_image_url
                    currentMainImageContainer.style.display = 'block'
                } else {
                    currentMainImageContainer.style.display = 'none'
                }

                // Clear any previous previews
                document.getElementById('editImagePreview').style.display = 'none'
                document.getElementById('editMainImagePreview').style.display = 'none'

                // Show the modal
                document.getElementById('editCategoryModal').style.display = 'block'
            } catch (error) {
                console.error('Error fetching category:', error)
                alert('Error fetching category details')
            }
        }

        // Handle image preview for edit form
        document.getElementById('editCategoryImage').addEventListener('change', function (event) {
            const file = event.target.files[0]
            if (file) {
                const reader = new FileReader()
                reader.onload = function (e) {
                    const preview = document.getElementById('editImagePreview')
                    preview.src = e.target.result
                    preview.style.display = 'block'
                }
                reader.readAsDataURL(file)
            }
        })

        // Add this with your other event listeners
        document.getElementById('categoryMainImage').addEventListener('change', function (event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const preview = document.getElementById('mainImagePreview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                }
                reader.readAsDataURL(file);
            }
        });

        // Add this with your other event listeners
        document.getElementById('editCategoryMainImage').addEventListener('change', function (event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const preview = document.getElementById('editMainImagePreview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                }
                reader.readAsDataURL(file);
            }
        });
        // Name color feedback
        document.getElementById('categoryNameColor').addEventListener('change', function (event) {
            const colorValue = this.value;
            this.style.backgroundColor = colorValue;
            const label = document.querySelector('label[for="categoryNameColor"]');
            label.innerHTML = `Category Name Color: <span style="color:${colorValue}">${colorValue}</span>`;
        });

        document.getElementById('editCategoryNameColor').addEventListener('change', function (event) {
            const colorValue = this.value;
            this.style.backgroundColor = colorValue;
            const label = document.querySelector('label[for="editCategoryNameColor"]');
            label.innerHTML = `Category Name Color: <span style="color:${colorValue}">${colorValue}</span>`;
        });

        // Description color feedback
        document.getElementById('categoryDescriptionColor').addEventListener('change', function (event) {
            const colorValue = this.value;
            this.style.backgroundColor = colorValue;
            const label = document.querySelector('label[for="categoryDescriptionColor"]');
            label.innerHTML = `Description Color: <span style="color:${colorValue}">${colorValue}</span>`;
        });

        document.getElementById('editCategoryDescriptionColor').addEventListener('change', function (event) {
            const colorValue = this.value;
            this.style.backgroundColor = colorValue;
            const label = document.querySelector('label[for="editCategoryDescriptionColor"]');
            label.innerHTML = `Description Color: <span style="color:${colorValue}">${colorValue}</span>`;
        });
        // Close modal when clicking the X
        document.querySelector('.close-modal').addEventListener('click', () => {
            document.getElementById('editCategoryModal').style.display = 'none'
        })

        // Close modal when clicking outside
        window.addEventListener('click', (event) => {
            const modal = document.getElementById('editCategoryModal')
            if (event.target === modal) {
                modal.style.display = 'none'
            }
        })

        // Handle edit form submission
        document.getElementById('editCategoryForm').addEventListener('submit', async (e) => {
            e.preventDefault()

            const id = document.getElementById('editCategoryId').value
            const name = document.getElementById('editCategoryName').value
            const bgImageFile = document.getElementById('editCategoryBgImage').files[0]
            const isMain = document.getElementById('editIsMainCategory').checked
            const description = document.getElementById('editCategoryDescription').value
            const imageFile = document.getElementById('editCategoryImage').files[0]
            const mainImageFile = document.getElementById('editCategoryMainImage').files[0]
            // Inside the edit form submission handler, add this line with the other variable definitions
            const color = document.getElementById('editCategoryColor').value;
            const nameColor = document.getElementById('editCategoryNameColor').value;
            const descriptionColor = document.getElementById('editCategoryDescriptionColor').value;
            const removeBgImage = document.getElementById('editCategoryForm').dataset.removeBgImage === 'true';
const removeMainImage = document.getElementById('editCategoryForm').dataset.removeMainImage === 'true';
            try {
                // Get the current category to compare changes
                const { data: currentCategory } = await supabase
                    .from('categories')
                    .select('image_url, main_image_url')
                    .eq('id', id)
                    .single()

                let imageUrl = currentCategory.image_url
                let mainImageUrl = currentCategory.main_image_url

                // Upload new image if selected
                if (imageFile) {
                    // Delete old image if exists
                    if (imageUrl) {
                        const oldFileName = imageUrl.split('/').pop()
                        const { error: deleteError } = await supabase.storage
                            .from('category-images')
                            .remove([oldFileName])

                        if (deleteError) console.error('Error deleting old image:', deleteError)
                    }

                    // Upload new image
                    const fileName = `category_${Date.now()}_${imageFile.name.replace(/\s+/g, '_')}`
                    const { data, error: uploadError } = await supabase.storage
                        .from('category-images')
                        .upload(fileName, imageFile)

                    if (uploadError) throw uploadError

                    // Get public URL for the new image
                    const { data: { publicUrl } } = supabase.storage
                        .from('category-images')
                        .getPublicUrl(fileName)

                    imageUrl = publicUrl
                }
                let bgImageUrl = currentCategory.bg_image_url

                // Upload new background image if selected
                if (bgImageFile) {
                    // Delete old background image if exists
                    if (bgImageUrl) {
                        const oldBgFileName = bgImageUrl.split('/').pop()
                        const { error: deleteBgError } = await supabase.storage
                            .from('category-images')
                            .remove([oldBgFileName])

                        if (deleteBgError) console.error('Error deleting old background image:', deleteBgError)
                    }

                    // Upload new background image
                    const bgFileName = `bg_category_${Date.now()}_${bgImageFile.name.replace(/\s+/g, '_')}`
                    const { data, error: uploadBgError } = await supabase.storage
                        .from('category-images')
                        .upload(bgFileName, bgImageFile)

                    if (uploadBgError) throw uploadBgError

                    // Get public URL for the new background image
                    const { data: { publicUrl } } = supabase.storage
                        .from('category-images')
                        .getPublicUrl(bgFileName)

                    bgImageUrl = publicUrl
                }
                // Upload new main image if selected
                if (mainImageFile) {
                    // Delete old main image if exists
                    if (mainImageUrl) {
                        const oldMainFileName = mainImageUrl.split('/').pop()
                        const { error: deleteMainError } = await supabase.storage
                            .from('category-images')
                            .remove([oldMainFileName])

                        if (deleteMainError) console.error('Error deleting old main image:', deleteMainError)
                    }

                    // Upload new main image
                    const mainFileName = `main_category_${Date.now()}_${mainImageFile.name.replace(/\s+/g, '_')}`
                    const { data, error: uploadMainError } = await supabase.storage
                        .from('category-images')
                        .upload(mainFileName, mainImageFile)

                    if (uploadMainError) throw uploadMainError

                    // Get public URL for the new main image
                    const { data: { publicUrl } } = supabase.storage
                        .from('category-images')
                        .getPublicUrl(mainFileName)

                    mainImageUrl = publicUrl
                }
                if (removeBgImage) {
                    // Delete old background image if exists
                    if (bgImageUrl) {
                        const oldBgFileName = bgImageUrl.split('/').pop();
                        const { error: deleteBgError } = await supabase.storage
                            .from('category-images')
                            .remove([oldBgFileName]);
                
                        if (deleteBgError) console.error('Error deleting old background image:', deleteBgError);
                    }
                    bgImageUrl = null; // Set to null to remove from database
                }
                
                if (removeMainImage) {
                    // Delete old main image if exists
                    if (mainImageUrl) {
                        const oldMainFileName = mainImageUrl.split('/').pop();
                        const { error: deleteMainError } = await supabase.storage
                            .from('category-images')
                            .remove([oldMainFileName]);
                
                        if (deleteMainError) console.error('Error deleting old main image:', deleteMainError);
                    }
                    mainImageUrl = null; // Set to null to remove from database
                }
                // Update the category
                // 1. First, modify the update category function by adding updated_at field
// In the editCategoryForm submit event listener, modify the supabase update call (around line 697)

// Update the category
const { error } = await supabase
    .from('categories')
    .update({
        name,
        is_main: isMain,
        description,
        image_url: imageUrl,
        main_image_url: mainImageUrl,
        bg_image_url: bgImageUrl,
        color: color,
        name_color: nameColor,
        description_color: descriptionColor,
        created_at: new Date().toISOString() // This ensures proper ISO format
    })
    .eq('id', id)

                if (error) throw error

                // Hide modal and reload categories
                document.getElementById('editCategoryModal').style.display = 'none'
                loadCategories()
            } catch (error) {
                console.error('Error updating category:', error)
                alert('Error updating category: ' + error.message)
            }
        });
        document.getElementById('editCategoryForm').dataset.removeBgImage = 'false';
document.getElementById('editCategoryForm').dataset.removeMainImage = 'false';
        // Add this event listener for the color picker
        document.getElementById('categoryColor').addEventListener('change', function (event) {
            // Update a visual indicator or the label to show the selected color
            const colorValue = this.value;
            this.style.backgroundColor = colorValue;
            // Optional: you can also update a label next to it
            const label = document.querySelector('label[for="categoryColor"]');
            label.innerHTML = `Category Color: <span style="color:${colorValue}">${colorValue}</span>`;
        });

        // Same for the edit color picker
        document.getElementById('editCategoryColor').addEventListener('change', function (event) {
            const colorValue = this.value;
            this.style.backgroundColor = colorValue;
            const label = document.querySelector('label[for="editCategoryColor"]');
            label.innerHTML = `Category Color: <span style="color:${colorValue}">${colorValue}</span>`;
        });
        // Add category with image
        // Update the add category submission
        document.getElementById('addCategoryForm').addEventListener('submit', async (e) => {
            e.preventDefault()
            const name = document.getElementById('categoryName').value
            const bgImageFile = document.getElementById('categoryBgImage').files[0]
            const isMain = document.getElementById('isMainCategory').checked
            const description = document.getElementById('categoryDescription').value
            const imageFile = document.getElementById('categoryImage').files[0]
            const mainImageFile = document.getElementById('categoryMainImage').files[0]
            const nameColor = document.getElementById('categoryNameColor').value;
            const descriptionColor = document.getElementById('categoryDescriptionColor').value;
            try {
                let imageUrl = null;
                let mainImageUrl = null;

                // Upload regular image if selected
                if (imageFile) {
                    const fileName = `category_${Date.now()}_${imageFile.name.replace(/\s+/g, '_')}`;
                    const { data, error: uploadError } = await supabase.storage
                        .from('category-images')
                        .upload(fileName, imageFile);

                    if (uploadError) throw uploadError;

                    // Get public URL for the uploaded image
                    const { data: { publicUrl } } = supabase.storage
                        .from('category-images')
                        .getPublicUrl(fileName);

                    imageUrl = publicUrl;
                }
                let bgImageUrl = null;

                // Upload background image if selected
                if (bgImageFile) {
                    const bgFileName = `bg_category_${Date.now()}_${bgImageFile.name.replace(/\s+/g, '_')}`;
                    const { data, error: uploadBgError } = await supabase.storage
                        .from('category-images')
                        .upload(bgFileName, bgImageFile);

                    if (uploadBgError) throw uploadBgError;

                    // Get public URL for the uploaded background image
                    const { data: { publicUrl } } = supabase.storage
                        .from('category-images')
                        .getPublicUrl(bgFileName);

                    bgImageUrl = publicUrl;
                }

                // Upload main image if selected
                if (mainImageFile) {
                    const mainFileName = `main_category_${Date.now()}_${mainImageFile.name.replace(/\s+/g, '_')}`;
                    const { data, error: uploadMainError } = await supabase.storage
                        .from('category-images')
                        .upload(mainFileName, mainImageFile);

                    if (uploadMainError) throw uploadMainError;

                    // Get public URL for the uploaded main image
                    const { data: { publicUrl } } = supabase.storage
                        .from('category-images')
                        .getPublicUrl(mainFileName);

                    mainImageUrl = publicUrl;
                }
                const color = document.getElementById('categoryColor').value;
                // Insert the category with both image URLs
                const { error } = await supabase
                .from('categories')
                .insert([{
                    name,
                    is_main: isMain,
                    description,
                    image_url: imageUrl,
                    main_image_url: mainImageUrl,
                    bg_image_url: bgImageUrl,
                    color: color,
                    name_color: nameColor,
                    description_color: descriptionColor,
                   
                }]);

                if (error) throw error;

                // Reset form
                document.getElementById('addCategoryForm').reset();
                document.getElementById('imagePreview').style.display = 'none';
                document.getElementById('mainImagePreview').style.display = 'none';
                loadCategories();
            } catch (error) {
                console.error('Error adding category:', error);
                alert('Error adding category: ' + error.message);
            }
        });

        // Delete category
        window.deleteCategory = async (id) => {
            if (!confirm('Are you sure you want to delete this category?')) return;

            try {
                // First get the category to check if it has images
                const { data: category, error: fetchError } = await supabase
                    .from('categories')
                    .select('image_url, main_image_url')
                    .eq('id', id)
                    .single();

                if (fetchError) throw fetchError;

                // Delete regular image if exists
                if (category.image_url) {
                    const fileName = category.image_url.split('/').pop();
                    const { error: storageError } = await supabase.storage
                        .from('category-images')
                        .remove([fileName]);

                    if (storageError) console.error('Error deleting image:', storageError);
                }
                if (category.bg_image_url) {
                    const bgFileName = category.bg_image_url.split('/').pop();
                    const { error: bgStorageError } = await supabase.storage
                        .from('category-images')
                        .remove([bgFileName]);

                    if (bgStorageError) console.error('Error deleting background image:', bgStorageError);
                }

                // Delete main image if exists
                if (category.main_image_url) {
                    const mainFileName = category.main_image_url.split('/').pop();
                    const { error: mainStorageError } = await supabase.storage
                        .from('category-images')
                        .remove([mainFileName]);

                    if (mainStorageError) console.error('Error deleting main image:', mainStorageError);
                }

                // Delete the category from the database
                const { error } = await supabase
                    .from('categories')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                loadCategories();
            } catch (error) {
                console.error('Error deleting category:', error);
                alert('Error deleting category: ' + error.message);
            }
        };

        // Load categories when page loads
        loadCategories();
    </script>
</body>

</html>